<!DOCTYPE html>
<html lang="ko">

<head>
    <%- include('../partials/head') %>
        <!-- include libraries(jQuery, library) -->
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
            integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
            crossorigin="anonymous"></script>
        <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
        <!-- Image Compression -->
        <script type="text/javascript"
            src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
        <style>
            .note-editor.note-frame {
                border: 1px solid #ddd;
                border-radius: 5px;
            }

            .note-editor .note-editing-area {
                background-color: white;
            }
        </style>
</head>

<body>
    <%- include('../partials/header') %>

        <div class="container" style="padding-top: 100px; padding-bottom: 50px;">
            <h1 class="text-center">
                <%= action==='create' ? '글 작성' : '글 수정' %>
            </h1>
            <div class="section-title"></div>

            <form action="/admin/<%= action %>/<%= type %>" method="POST" enctype="multipart/form-data"
                class="admin-form-container"
                style="max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">

                <% if (action==='update' ) { %>
                    <input type="hidden" name="id" value="<%= item.id %>">
                    <% } %>

                        <% fields.forEach(function(field) { %>
                            <div style="margin-bottom: 1.5rem;">
                                <label for="<%= field.name %>"
                                    style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                                    <%= field.label %>
                                </label>

                                <% if (field.type==='textarea' ) { %>
                                    <textarea id="<%= field.name %>" name="<%= field.name %>" rows="10"
                                        style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px;"><%- item ? item[field.name] : '' %></textarea>
                                    <% } else if (field.type==='file' ) { %>
                                        <div class="file-upload-container"
                                            style="text-align: center; border: 2px dashed #eee; padding: 2.5rem; border-radius: 15px; background: #fafafa; transition: all 0.3s ease; cursor: pointer;"
                                            onclick="document.getElementById('<%= field.name %>').click()">

                                            <div id="preview-container-<%= field.name %>"
                                                style="<%= (item && item[field.name]) ? 'margin-bottom: 1.5rem;' : 'display:none; margin-bottom: 1.5rem;' %>">
                                                <div id="file-previews-<%= field.name %>"
                                                    style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
                                                    <% if (item && item[field.name]) { const
                                                        files=Array.isArray(item[field.name]) ? item[field.name] :
                                                        [item[field.name]]; files.forEach(fileUrl=> {
                                                        if (fileUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) { %>
                                                        <img src="<%= fileUrl %>"
                                                            style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                                                        <% } else { %>
                                                            <div style="width: 120px; text-align: center;">
                                                                <i class="fas fa-file-alt"
                                                                    style="font-size: 2.5rem; color: var(--color-primary);"></i>
                                                                <p
                                                                    style="font-size: 0.8rem; color: #333; margin-top: 0.5rem; word-break: break-all;">
                                                                    <%= fileUrl.split('/').pop() %>
                                                                </p>
                                                            </div>
                                                            <% } }); } %>
                                                </div>

                                                <p
                                                    style="font-size: 0.85rem; color: var(--color-primary); margin-top: 1.5rem; font-weight: 500;">
                                                    <i class="fas fa-sync-alt"></i> 클릭하여 파일 변경
                                                </p>
                                            </div>

                                            <div id="upload-placeholder-<%= field.name %>"
                                                style="<%= (item && item[field.name]) ? 'display:none;' : 'display:flex;' %> flex-direction: column; align-items: center; justify-content: center;">
                                                <div
                                                    style="width: 70px; height: 70px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1.2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                                                    <i class="fas fa-cloud-upload-alt"
                                                        style="font-size: 2rem; color: var(--color-primary);"></i>
                                                </div>
                                                <p
                                                    style="color: #444; font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">
                                                    파일을 선택해 주세요</p>
                                                <p style="color: #888; font-size: 0.9rem; margin-bottom: 1.5rem;">
                                                    <%= field.multiple ? '여러 개의 이미지 또는 파일을 선택할 수 있습니다'
                                                        : '이미지 또는 PDF 파일을 업로드할 수 있습니다' %>
                                                </p>
                                                <span class="btn btn-outline"
                                                    style="border-color: var(--color-primary); color: var(--color-primary); background: #fff; pointer-events: none;">
                                                    내 컴퓨터에서 찾기
                                                </span>
                                            </div>

                                            <input type="file" id="<%= field.name %>" name="<%= field.name %>"
                                                style="display: none;" <%=field.multiple ? 'multiple' : '' %>
                                            onchange="handleFileSelect(this, '<%= field.name %>')"
                                                onclick="event.stopPropagation()">
                                        </div>

                                        <script>
                                            async function handleFileSelect(input, fieldName) {
                                                const container = document.getElementById('preview-container-' + fieldName);
                                                const placeholder = document.getElementById('upload-placeholder-' + fieldName);
                                                const previewList = document.getElementById('file-previews-' + fieldName);

                                                if (input.files && input.files.length > 0) {
                                                    // Image Compression Options
                                                    const options = {
                                                        maxSizeMB: 1,
                                                        maxWidthOrHeight: 1200,
                                                        useWebWorker: true
                                                    };

                                                    // Create new DataTransfer to hold compressed files
                                                    const dataTransfer = new DataTransfer();

                                                    placeholder.style.display = 'none';
                                                    container.style.display = 'block';
                                                    previewList.innerHTML = '';

                                                    // Process files
                                                    for (let file of input.files) {
                                                        let fileToUpload = file;

                                                        if (file.type.startsWith('image/')) {
                                                            try {
                                                                // Compress image
                                                                const compressedFile = await imageCompression(file, options);
                                                                // Create a new File object with correct name and type
                                                                fileToUpload = new File([compressedFile], file.name, { type: file.type });
                                                                console.log(`Compressed: ${file.size / 1024 / 1024}MB -> ${fileToUpload.size / 1024 / 1024}MB`);
                                                            } catch (error) {
                                                                console.error('Compression failed:', error);
                                                            }
                                                        }

                                                        dataTransfer.items.add(fileToUpload);

                                                        // Preview Logic
                                                        const itemWrapper = document.createElement('div');
                                                        itemWrapper.style.width = '120px';
                                                        itemWrapper.style.textAlign = 'center';

                                                        if (fileToUpload.type.startsWith('image/')) {
                                                            const reader = new FileReader();
                                                            const img = document.createElement('img');
                                                            img.style.width = '120px';
                                                            img.style.height = '120px';
                                                            img.style.objectFit = 'cover';
                                                            img.style.borderRadius = '8px';
                                                            img.style.border = '3px solid white';
                                                            img.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';

                                                            reader.onload = function (e) {
                                                                img.src = e.target.result;
                                                            }
                                                            reader.readAsDataURL(fileToUpload);
                                                            itemWrapper.appendChild(img);
                                                        } else {
                                                            const icon = document.createElement('i');
                                                            icon.className = 'fas fa-file-alt';
                                                            icon.style.fontSize = '2.5rem';
                                                            icon.style.color = 'var(--color-primary)';

                                                            const name = document.createElement('p');
                                                            name.style.fontSize = '0.8rem';
                                                            name.style.color = '#333';
                                                            name.style.marginTop = '0.5rem';
                                                            name.style.wordBreak = 'break-all';
                                                            name.textContent = fileToUpload.name;

                                                            itemWrapper.appendChild(icon);
                                                            itemWrapper.appendChild(name);
                                                        }
                                                        previewList.appendChild(itemWrapper);
                                                    }

                                                    // Update input files with compressed ones
                                                    input.files = dataTransfer.files;
                                                }
                                            }
                                        </script>
                                        <% } else { %>
                                            <input type="<%= field.type || 'text' %>" id="<%= field.name %>"
                                                name="<%= field.name %>" value="<%= item ? item[field.name] : '' %>"
                                                style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px;">
                                            <% } %>
                            </div>
                            <% }); %>

                                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2.5rem;">
                                    <a href="javascript:history.back()" class="btn btn-outline"
                                        style="display: flex; align-items: center; gap: 0.5rem; border: 1px solid #ced4da; color: #495057; background: #fff; transition: all 0.2s;">
                                        <i class="fas fa-arrow-left"></i> 취소 및 목록으로
                                    </a>
                                    <button type="submit" class="btn btn-primary"
                                        style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 2.5rem;">
                                        <i class="fas fa-check"></i>
                                        <%= action==='create' ? '내용 등록' : '수정 완료' %>
                                    </button>
                                </div>
            </form>
        </div>

        <%- include('../partials/footer') %>
            <script src="/js/main.js"></script>
            <script>
                $(document).ready(function () {
                    $('textarea').summernote({
                        placeholder: '내용을 입력해주세요...',
                        tabsize: 2,
                        height: 400,
                        lang: 'ko-KR',
                        toolbar: [
                            ['style', ['style']],
                            ['font', ['bold', 'underline', 'clear']],
                            ['color', ['color']],
                            ['para', ['ul', 'ol', 'paragraph']],
                            ['table', ['table']],
                            ['insert', ['link', 'picture', 'video']],
                            ['view', ['fullscreen', 'codeview', 'help']]
                        ]
                    });
                });
            </script>
</body>

</html>